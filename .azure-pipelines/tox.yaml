trigger:
  branches:
    include:
      - main

pool:
  name: k8s

steps:

  - script: |
      apt-get update
      apt-get install -y python3 python3-pip libglib2.0-0 libsm6 libxext6 libxrender-dev
    displayName: 'Install Python 3, pip, and system dependencies on k8s agent'

  - script: |
      python3 -m pip install --upgrade pip
      pip3 install uv
    displayName: 'Install uv using pip'

  - script: |
      uv python install 3.12
    displayName: 'Set up Python 3.12 using uv'

  - script: |
      uv sync --all-extras --dev
    displayName: 'Install project dependencies with uv'

  - script: |
      uv tool install tox --with tox-uv
      export PATH=$PATH:~/.local/bin
      tox -v -- --tb=short -ra
    displayName: 'Run tox environments for Python 3.12, 3.11, and 3.10 using uv'

  - task: PublishTestResults@2
    inputs:
      testResultsFiles: '**/TEST-*.xml'
    condition: succeededOrFailed()
    displayName: 'Publish Test Results'
