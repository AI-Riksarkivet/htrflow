# .azure-pipelines/tox.yaml
trigger:
  branches:
    include:
      - main

pool:
  name: k8s

steps:

  - script: |
      sudo apt-get update
      sudo apt-get install -y libgl1-mesa-glx
    displayName: 'Install OpenCV system dependencies'

  # Install uv using pip
  - script: |
      python3 -m pip install --upgrade pip
      pip3 install uv
    displayName: 'Install uv using pip'

  # Set up Python 3.12 using uv
  - script: |
      uv python install 3.12
    displayName: 'Set up Python 3.12 using uv'

  # Install project dependencies using uv
  - script: |
      uv sync --dev
    displayName: 'Install project dependencies with uv'

  # Install tox using uv
  - script: |
      uv tool install tox --with tox-uv
    displayName: 'Install tox using uv'

  # Run tox environments using 'uv tool run'
  - script: |
      uv tool run tox -v
    displayName: 'Run tox environments for Python 3.12, 3.11, and 3.10 using uv'

  # Publish test results
  - task: PublishTestResults@2
    inputs:
      testResultsFiles: '**/TEST-*.xml'
    condition: succeededOrFailed()
    displayName: 'Publish Test Results'
